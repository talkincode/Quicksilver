# 开发计划 - 测试完善与仪表盘优化 (Week 45, 2025)

> **计划制定时间**: 2025-11-05 (更新)  
> **计划执行周期**: 本周 (Week 45: 11 月 5 日 - 11 月 11 日)  
> **下次评审时间**: 2025-11-11 17:00  
> **规划依据**: `.github/prompts/planner.prompt.md`

---

## 📊 项目状态诊断

**当前进度**: 97% 完成 ✅  
**测试覆盖率**: 58.8% (目标: 70%，差距: 11.2%) ⚠️  
**关键阻塞**: 无阻塞性问题 ✅  
**编译状态**: 通过 ✅  
**代码质量**: 通过 go vet, go fmt ✅

**本周已完成** (2025-11-05):

- ✅ **修复测试失败**: TestAdminDeleteUser 通过
- ✅ **实现软删除**: DeleteUser 改为状态更新，保留历史数据
- ✅ **新增测试**: TestDeleteUser (3 个), TestHardDeleteUser (2 个)
- ✅ **覆盖率提升**: 57.7% → 58.8% ⬆️ 1.1%
- ✅ **代码质量报告**: 生成 QUALITY_ANALYSIS_REPORT.md

**待解决问题**:

- ⚠️ Service 层覆盖率 68.5% (低于 80% 要求)
- ⚠️ Config 层覆盖率 6.7% (严重不足)
- ⚠️ ListUsers 函数 0% 覆盖率
- ⚠️ Streamlit 仪表盘 80% 完成 (差 20%)

---

## 🎯 本周目标 (SMART 原则)

### 主要里程碑

1. **Specific (具体)**: 提升测试覆盖率至 70%+，补充 ListUsers 和 Config 层测试
2. **Measurable (可衡量)**: 覆盖率从 58.8% → 72%+，Service 层 68.5% → 80%+
3. **Achievable (可实现)**: 预估 7.5 小时工作量，本周可完成
4. **Relevant (相关)**: 满足项目质量标准，为生产部署做准备
5. **Time-bound (有时限)**: 2025-11-11 前完成

### 成功指标

| 指标             | 当前值 | 目标值   | 差距     |
| ---------------- | ------ | -------- | -------- |
| 整体覆盖率       | 58.8%  | **72%+** | ⬆️ 13.2% |
| Service 层       | 68.5%  | **80%+** | ⬆️ 11.5% |
| Config 层        | 6.7%   | **70%+** | ⬆️ 63.3% |
| ListUsers 覆盖率 | 0%     | **80%+** | ⬆️ 80%   |
| Streamlit 仪表盘 | 80%    | **100%** | ⬆️ 20%   |
| 测试通过率       | 100%   | **100%** | ✅ 保持  |

---

## 📝 任务列表 (优先级排序)

### P0 - 必须完成 (阻塞性)

✅ **无 P0 阻塞性问题** - 所有核心功能已实现且测试通过

---

### P1 - 高优先级 (本周内完成)

#### 任务 #1: 补充 ListUsers 测试用例

**优先级**: P1  
**预估**: 1 小时  
**状态**: ⏳ 待开始

**目标**: 为 `UserService.ListUsers()` 补充完整测试用例，覆盖率从 0% 提升至 80%+

**价值**:

- 消除 Service 层最大的测试缺口
- 验证分页、搜索、过滤逻辑正确性
- 提升整体覆盖率约 2-3%

**验收标准**:

- [ ] TestListUsers 包含至少 5 个子测试
- [ ] 覆盖分页场景 (page, limit)
- [ ] 覆盖搜索场景 (email 关键字)
- [ ] 覆盖状态过滤 (active, inactive, suspended)
- [ ] 覆盖空结果和边界条件
- [ ] ListUsers 覆盖率 ≥ 80%

**技术要点**:

- 使用 `testutil.SeedUser` 创建测试数据
- 验证分页参数计算正确 (offset, limit)
- 验证总数统计准确
- 验证结果排序 (默认按创建时间倒序)

**执行步骤**:

1. [ ] 编写测试用例 - TDD 红阶段 (20 分钟)
2. [ ] 实现或修复 ListUsers 逻辑 (如需要) (20 分钟)
3. [ ] 运行测试验证通过 (10 分钟)
4. [ ] 检查覆盖率报告 (10 分钟)

**测试用例模板**:

```go
func TestListUsers(t *testing.T) {
    t.Run("List all users with default pagination", func(t *testing.T) {
        // Given: 创建 10 个测试用户
        // When: 调用 ListUsers(page=1, limit=5)
        // Then: 返回 5 个用户，total=10
    })

    t.Run("Search users by email", func(t *testing.T) {
        // Given: 用户邮箱包含 "test"
        // When: ListUsers(search="test")
        // Then: 只返回匹配的用户
    })

    t.Run("Filter users by status", func(t *testing.T) {
        // Given: 部分用户状态为 inactive
        // When: ListUsers(status="active")
        // Then: 只返回 active 用户
    })
}
```

---

#### 任务 #2: 补充 Config 层测试

**优先级**: P1  
**预估**: 1.5 小时  
**状态**: ⏳ 待开始

**目标**: Config 层覆盖率从 6.7% 提升至 70%+

**价值**:

- 验证配置加载和验证逻辑健壮性
- 防止配置错误导致生产环境故障
- 提升整体覆盖率约 3-5%

**验收标准**:

- [ ] 测试 YAML 配置文件加载
- [ ] 测试环境变量覆盖机制
- [ ] 测试配置验证规则
- [ ] 测试缺失配置的默认值
- [ ] 测试无效配置的错误处理
- [ ] Config 层覆盖率 ≥ 70%

**技术要点**:

- 使用临时文件测试配置加载
- 使用 `t.Setenv()` 测试环境变量
- 验证 Viper 自动环境变量映射 (QS_SERVER_PORT)
- 测试 `GetDSN()` 等辅助方法

**执行步骤**:

1. [ ] 分析当前 Config 代码结构 (15 分钟)
2. [ ] 编写配置加载测试 (30 分钟)
3. [ ] 编写环境变量测试 (20 分钟)
4. [ ] 编写验证和错误处理测试 (20 分钟)
5. [ ] 运行测试并验证覆盖率 (15 分钟)

**测试用例模板**:

```go
func TestLoadConfig(t *testing.T) {
    t.Run("Load valid config file", ...)
    t.Run("Load config with env override", ...)
    t.Run("Return error on missing file", ...)
    t.Run("Return error on invalid YAML", ...)
}

func TestConfigValidation(t *testing.T) {
    t.Run("Validate database config", ...)
    t.Run("Validate server config", ...)
    t.Run("Default values when missing", ...)
}
```

---

#### 任务 #3: 完善 Streamlit 仪表盘

**优先级**: P1  
**预估**: 2 小时  
**状态**: ⏳ 待开始

**目标**: 完成 Streamlit 仪表盘剩余 20% 功能，达到生产可用状态

**价值**:

- 提供完整的管理工具
- 可视化监控系统状态
- 简化运维操作

**验收标准**:

- [ ] 余额管理模块实现 (查询、充值、提现)
- [ ] 系统监控模块实现 (API 状态、数据库连接)
- [ ] UI 样式优化 (统一主题、响应式布局)
- [ ] 错误处理完善 (友好的错误提示)
- [ ] 所有功能通过手动测试

**技术要点**:

- 使用 `dashboard/api/client.py` 封装 API 调用
- Streamlit 组件: `st.metric()`, `st.dataframe()`, `st.form()`
- 实时刷新: `st.rerun()` 或定时器
- 异常处理: try-except 包装 API 调用

**执行步骤**:

1. [ ] 实现余额管理页面 (45 分钟)
2. [ ] 实现系统监控页面 (30 分钟)
3. [ ] UI 样式优化 (30 分钟)
4. [ ] 测试和调试 (15 分钟)

---

### P2 - 中优先级 (本月内)

#### 任务 #4: 运行 CCXT 客户端集成测试

**优先级**: P2  
**预估**: 1 小时  
**状态**: 📅 计划中

**目标**: 使用 CCXT Python 客户端验证 API 兼容性

**价值**: 验证 CCXT 标准兼容性，发现潜在的格式问题

**验收标准**:

- [ ] 运行 `scripts/test_ccxt_client.py`
- [ ] 所有测试用例通过
- [ ] 文档记录测试结果

---

#### 任务 #5: 添加管理员权限中间件

**优先级**: P2  
**预估**: 1.5 小时  
**状态**: 📅 计划中

**目标**: 为管理员 API 添加权限验证，防止普通用户越权访问

**验收标准**:

- [ ] 实现 AdminAuth 中间件
- [ ] User 模型添加 role 字段
- [ ] 测试覆盖率 ≥ 80%

---

### P3 - 低优先级 (待定)

#### 任务 #6: 实现 Binance API 集成 (TODO)

#### 任务 #7: 添加 API 速率限制 (TODO)

1. [x] 修改 `internal/api/handlers.go:35` - 10 分钟
2. [x] 更新单元测试 - 10 分钟
3. [x] 验证配置文件包含正确的交易对列表 - 5 分钟
4. [x] 运行测试确认 - 5 分钟

---

#### 任务 #4: 编写端到端 (E2E) 测试脚本

**优先级**: P1 (质量保障)

**目标**: 编写覆盖完整交易流程的自动化测试脚本

**价值**:

- 验证系统各模块协作正常
- 快速发现集成问题
- 支持回归测试

**验收标准**:

- [x] 创建 `scripts/e2e_test.sh`
- [x] 测试流程:
  1. 启动服务 (`make run` 后台运行)
  2. 等待服务就绪 (健康检查)
  3. 创建测试用户 (通过 SQL)
  4. 查询余额 (API 调用)
  5. 创建市价买单
  6. 等待订单成交
  7. 验证余额变化
  8. 撤销未成交订单
  9. 清理测试数据
- [x] 测试脚本返回正确的退出码 (成功=0, 失败=1)

**预估时间**: 2 小时

**技术要点**:

- 使用 `curl` 调用 API
- 使用 `jq` 解析 JSON 响应
- 使用 `psql` 执行 SQL 命令
- 使用 `trap` 确保清理资源

**前置依赖**: 任务 #1 (API 正常工作)

**执行步骤**:

1. [x] 编写脚本骨架 - 30 分钟
2. [x] 实现各测试步骤 - 1 小时
3. [x] 调试和优化 - 30 分钟

---

#### 任务 #5: 性能基准测试和优化

**优先级**: P1 (性能验证)

**目标**: 测试关键 API 的响应时间，确保满足性能要求

**价值**:

- 确保系统满足性能目标 (P99 < 100ms)
- 识别性能瓶颈
- 建立性能基线

**验收标准**:

- [x] 使用 `wrk` 或 `hey` 进行压力测试
- [x] 测试端点:
  - GET `/v1/ticker/BTC-USDT`
  - GET `/v1/balance`
  - POST `/v1/order`
- [x] 记录关键指标:
  - P50 响应时间
  - P99 响应时间
  - 吞吐量 (RPS)
  - 错误率
- [x] P99 响应时间 < 100ms ✅

**预估时间**: 1.5 小时

**技术要点**:

```bash
# 使用 wrk 进行压力测试
wrk -t4 -c100 -d30s http://localhost:8080/v1/ticker/BTC-USDT

# 使用 hey 进行测试
hey -n 10000 -c 100 http://localhost:8080/v1/ticker/BTC-USDT
```

**前置依赖**: 无

**执行步骤**:

1. [x] 安装测试工具 - 10 分钟
2. [x] 编写测试脚本 - 30 分钟
3. [x] 执行测试并记录数据 - 30 分钟
4. [x] 分析结果并优化 - 20 分钟

---

### P2 - 中优先级 (可选)

#### 任务 #6: 提升 Config 层测试覆盖率

**优先级**: P2 (质量提升)

**目标**: 将 Config 层覆盖率从 6.7% 提升至 30%+

**价值**:

- 提高配置解析的可靠性
- 确保配置验证逻辑正确

**验收标准**:

- [x] 添加配置验证测试
- [x] 添加环境变量覆盖测试
- [x] 覆盖率 > 30%

**预估时间**: 1 小时

**执行步骤**:

1. [x] 分析现有测试缺口 - 15 分钟
2. [x] 编写新测试用例 - 30 分钟
3. [x] 验证覆盖率提升 - 15 分钟

---

#### 任务 #7: 实现 Binance 数据源支持

**优先级**: P2 (增强功能)

**目标**: 添加 Binance 作为备用数据源，提高系统可靠性

**价值**:

- 数据源冗余，提高可用性
- 支持多数据源切换
- 为后续扩展打基础

**验收标准**:

- [x] 实现 `updateBinanceTickers()` 函数
- [x] 支持数据源配置切换
- [x] 添加单元测试
- [x] 集成测试验证

**预估时间**: 3 小时

**技术要点**:

- Binance API: `https://api.binance.com/api/v3/ticker/price`
- 响应格式: `{"symbol":"BTCUSDT","price":"50000.50"}`
- 需要格式转换: `BTCUSDT` → `BTC/USDT`

**前置依赖**: 无

**执行步骤**:

1. [x] 研究 Binance API 文档 - 30 分钟
2. [x] 实现 API 调用 - 1 小时
3. [x] 编写测试 - 1 小时
4. [x] 集成和验证 - 30 分钟

---

## ⚠️ 风险和依赖

### 技术风险

1. **风险**: CCXT 格式兼容性问题

   - **影响**: 可能需要多次调整格式
   - **缓解措施**: 参考 CCXT 官方文档，使用真实客户端测试

2. **风险**: 性能测试发现严重瓶颈
   - **影响**: 需要重构优化，延期上线
   - **缓解措施**: 提前进行基准测试，分阶段优化

### 外部依赖

1. **依赖**: Hyperliquid API 稳定性

   - **状态**: 目前稳定 ✅
   - **备选方案**: 实现 Binance 数据源 (任务 #7)

2. **依赖**: CCXT 库最新版本
   - **状态**: 已安装 (v4.x)
   - **备选方案**: 无需备选，CCXT 成熟稳定

---

## 🔄 迭代策略

### 本周迭代

**Day 1-2 (周一至周二)**:

- 任务 #1: CCXT 格式转换 (4h)
- 任务 #3: 优化 GetMarkets (0.5h)
- 任务 #6: Config 测试提升 (1h)

**Day 3-4 (周三至周四)**:

- 任务 #2: CCXT 集成测试 (3h)
- 任务 #4: E2E 测试脚本 (2h)
- 任务 #5: 性能测试 (1.5h)

**Day 5 (周五)**:

- 代码审查和重构
- 文档更新
- 项目复盘

### 下周预览

- 部署到测试环境
- 用户验收测试 (UAT)
- 性能优化迭代
- 准备生产发布

---

## 📈 进度跟踪

| 任务               | 优先级 | 预估 | 实际 | 状态      | 完成度 |
| ------------------ | ------ | ---- | ---- | --------- | ------ |
| #1 CCXT 格式转换   | P0     | 4h   | -    | 📅 计划中 | 0%     |
| #2 CCXT 集成测试   | P0     | 3h   | -    | 📅 计划中 | 0%     |
| #3 优化 GetMarkets | P1     | 0.5h | -    | 📅 计划中 | 0%     |
| #4 E2E 测试脚本    | P1     | 2h   | -    | 📅 计划中 | 0%     |
| #5 性能基准测试    | P1     | 1.5h | -    | 📅 计划中 | 0%     |
| #6 Config 测试提升 | P2     | 1h   | -    | 📅 计划中 | 0%     |
| #7 Binance 数据源  | P2     | 3h   | -    | 📋 可选   | 0%     |

**总预估时间**: 15 小时 (P0+P1: 11 小时, P2: 4 小时)  
**本周可用时间**: 20 小时  
**缓冲余量**: 25% ✅

---

## 📊 质量指标追踪

### 代码质量

| 指标                 | 当前值 | 目标值 | 达成情况  |
| -------------------- | ------ | ------ | --------- |
| 测试覆盖率           | 75.2%  | > 70%  | ✅ 已达成 |
| GolangCI-Lint 通过率 | ~85%   | > 95%  | ⏳ 进行中 |
| 代码重复度           | 中等   | 低     | ⏳ 待改进 |
| 圈复杂度             | < 15   | < 15   | ✅ 已达成 |

### 性能指标

| 指标             | 当前值 | 目标值  | 达成情况  |
| ---------------- | ------ | ------- | --------- |
| API P99 响应时间 | 未测试 | < 100ms | ⏳ 待测试 |
| 订单处理 TPS     | 未测试 | > 100   | ⏳ 待测试 |
| 行情更新延迟     | < 1s   | < 2s    | ✅ 已达成 |

---

## 🛠️ 开发工具和命令

### 测试相关

```bash
# 运行所有测试
make test

# 仅单元测试
make test-unit

# 查看覆盖率
make test-coverage
open coverage.html

# 性能基准测试
make bench
```

### 代码质量

```bash
# 完整质量检查
make quality-check

# 格式检查
make fmt-check

# Lint 检查
make lint

# 静态分析
make vet

# 竞态检测
make race
```

### API 测试

```bash
# 使用 httpie
http GET :8080/v1/ticker/BTC-USDT
http POST :8080/v1/order symbol=BTC/USDT side=buy type=market amount=0.1 \
  X-API-Key:test-key X-API-Secret:test-secret

# 使用 curl
curl -X GET http://localhost:8080/v1/ticker/BTC-USDT
curl -X POST http://localhost:8080/v1/order \
  -H "X-API-Key: test-key" \
  -H "X-API-Secret: test-secret" \
  -d '{"symbol":"BTC/USDT","side":"buy","type":"market","amount":0.1}'
```

---

## 🎉 成功标准

### 本周结束时应达到的状态

- ✅ **CCXT 兼容性**: 可使用 CCXT Python 客户端完成完整交易流程
- ✅ **测试完整性**: E2E 测试通过，覆盖主要业务场景
- ✅ **性能达标**: API P99 响应时间 < 100ms
- ✅ **代码质量**: GolangCI-Lint 通过率 > 95%
- ✅ **文档完善**: API 文档、使用示例、部署指南完整

### 下周可以开始的工作

- 部署到测试环境
- 邀请用户进行 UAT
- 准备生产发布 Checklist
- 性能调优和监控设置

---

## 📝 每日任务清单

### Monday (11 月 4 日)

- [x] 创建本周开发计划 ✅
- [ ] 任务 #1: 开始 CCXT 格式转换 (2h)
- [ ] 任务 #3: 优化 GetMarkets (0.5h)

### Tuesday (11 月 5 日)

- [ ] 任务 #1: 完成 CCXT 格式转换 (2h)
- [ ] 任务 #6: 提升 Config 测试覆盖率 (1h)

### Wednesday (11 月 6 日)

- [ ] 任务 #2: CCXT 集成测试 (3h)

### Thursday (11 月 7 日)

- [ ] 任务 #4: E2E 测试脚本 (2h)
- [ ] 任务 #5: 性能基准测试 (1.5h)

### Friday (11 月 8 日)

- [ ] 代码审查和重构 (2h)
- [ ] 文档更新 (1h)
- [ ] 项目复盘 (1h)

---

## 🔍 检查清单

### 每日检查

- [ ] 查看今日任务列表
- [ ] 至少 1 次代码提交
- [ ] 更新任务进度
- [ ] 记录遇到的问题

### 每周检查

- [ ] 制定下周计划
- [ ] 运行 `make quality-check`
- [ ] 更新项目文档
- [ ] Sprint 回顾会议

---

**计划制定者**: AI Development Planner  
**审核者**: Quicksilver 开发团队  
**版本**: v1.0.0

---

## 📚 参考资料

- **CCXT 文档**: https://docs.ccxt.com/
- **系统设计**: `docs/system-design-mvp.md`
- **开发指南**: `.github/copilot-instructions.md`
- **项目状态**: `PROJECT_STATUS.md`
- **质量报告**: `QUALITY_REPORT.md`
