# Hyper-Sim：CCXT 兼容的精简模拟交易所系统设计（MVP 版）

> 版本：MVP v1.0  
> 技术栈：Go + Echo + GORM + PostgreSQL + TimescaleDB  
> 原则：**最小可行产品**、**快速开发**、**基础功能优先**

---

## 0. 系统架构概览

### 0.1 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        客户端层                                  │
├────────────────────────────┬────────────────────────────────────┤
│      CCXT 客户端           │       简单管理界面 (UI)             │
│   (Python/JS/etc)          │       (可选Web界面)                 │
└────────────┬───────────────┴────────────────┬───────────────────┘
             │                                │
             │         HTTP REST API          │
             └────────────────┬───────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────────┐
│                      Echo Web Server                             │
│                     (Go HTTP Framework)                          │
├──────────────────────────────────────────────────────────────────┤
│                        API Gateway                               │
│  ┌──────────────┐  ┌──────────────┐  ┌────────────────────┐    │
│  │  认证中间件  │  │  参数验证    │  │   错误处理         │    │
│  │  (API Key)   │  │  (Validator) │  │   (Error Handler)  │    │
│  └──────────────┘  └──────────────┘  └────────────────────┘    │
└──────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌───────────────┐    ┌────────────────┐    ┌──────────────┐
│  交易模块     │    │   行情模块     │    │  账户模块    │
│  (Trading)    │    │   (Market)     │    │  (Account)   │
├───────────────┤    ├────────────────┤    ├──────────────┤
│ • 订单处理    │    │ • 行情获取     │    │ • 余额管理   │
│ • 订单撮合    │    │ • 数据缓存     │    │ • 冻结/解冻  │
│ • 订单查询    │    │ • 定时更新     │    │ • 资金流水   │
│ • 订单撤销    │    │ • Ticker服务   │    │ • 用户管理   │
└───────┬───────┘    └────────┬───────┘    └──────┬───────┘
        │                     │                   │
        │      ┌──────────────┼───────────────────┘
        │      │              │
        ▼      ▼              ▼
┌─────────────────────────────────────────────────────────┐
│              撮合引擎 (Matching Engine)                  │
│  ┌──────────────────────────────────────────────────┐   │
│  │  • 市价单即时撮合                                │   │
│  │  • 限价单价格匹配                                │   │
│  │  • 订单薄管理 (简化版)                           │   │
│  │  • 成交记录生成                                  │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────┬───────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│              数据访问层 (GORM + PostgreSQL)              │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │
│  │  users   │ │ balances │ │  orders  │ │  trades  │   │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │
│  ┌──────────┐                                           │
│  │ tickers  │      PostgreSQL 16 + GORM                 │
│  └──────────┘                                           │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
        ┌─────────────────────────────────┐
        │   外部数据源                    │
        │   Binance API (行情数据)        │
        └─────────────────────────────────┘
```

### 0.2 数据流向

```
下单流程:
CCXT Client → API Gateway → 认证 → 交易模块 → 余额检查 → 撮合引擎 → DB
                                                              ↓
取消订单:                                              成交记录 + 余额更新
CCXT Client → API Gateway → 认证 → 交易模块 → 订单状态更新 → DB

行情查询:
CCXT Client → API Gateway → 行情模块 → 内存缓存 → [缓存miss] → DB
                                          ↓
                                    [缓存hit] → 返回

行情更新 (后台任务):
定时器 → Binance API → 行情模块 → 内存缓存 + DB更新
```

### 0.3 MVP 核心原则

| 原则         | 说明                  | 优势                         |
| ------------ | --------------------- | ---------------------------- |
| **单体架构** | 避免微服务复杂度      | 开发快速、部署简单、易于调试 |
| **内存优先** | 避免 Redis 等外部依赖 | 降低运维成本、减少网络延迟   |
| **功能聚焦** | 只实现核心交易功能    | 快速验证、迭代高效           |
| **简化设计** | 避免过度工程化        | 代码清晰、维护容易           |
| **渐进增强** | 预留扩展接口          | 支持后续迭代升级             |

---

## 1. 功能范围定义

### 1.1 必须实现的核心功能 ✅

```
┌──────────────────────────────────────────────────────────────┐
│                      核心交易功能                            │
├──────────────────────────────────────────────────────────────┤
│  ✅ 单交易对支持       │  BTC/USDT 现货交易                 │
│  ✅ 基础订单类型       │  市价单 + 限价单                   │
│  ✅ 用户系统           │  账户管理、余额管理                │
│  ✅ CCXT 兼容性        │  兼容 CCXT 基础 API                │
│  ✅ 行情数据同步       │  从 Binance 获取实时行情           │
│  ✅ 订单管理           │  下单、查询、撤销                  │
│  ✅ 成交记录           │  交易历史查询                      │
└──────────────────────────────────────────────────────────────┘
```

### 1.2 暂不包含的功能 ❌

```
┌──────────────────────────────────────────────────────────────┐
│                    延后实现的功能                            │
├──────────────────────────────────────────────────────────────┤
│  ❌ 合约交易           │  留待 v2.0 版本实现                │
│  ❌ 多交易对           │  先验证单交易对逻辑                │
│  ❌ 高级订单类型       │  IOC/FOK/止损止盈等                │
│  ❌ 复杂风控系统       │  仅做基础余额检查                  │
│  ❌ 高可用部署         │  单机验证即可                      │
│  ❌ 完整监控告警       │  基础日志足够                      │
│  ❌ WebSocket 推送     │  REST API 优先                     │
│  ❌ 订单薄深度         │  简化撮合逻辑                      │
└──────────────────────────────────────────────────────────────┘
```

### 1.3 功能优先级矩阵

| 功能模块   | 优先级 | 复杂度 | 预计工时 | 依赖关系        |
| ---------- | ------ | ------ | -------- | --------------- |
| 数据库设计 | P0     | 低     | 1 天     | 无              |
| 用户认证   | P0     | 低     | 2 天     | 数据库          |
| 账户余额   | P0     | 中     | 3 天     | 用户认证        |
| 行情同步   | P0     | 中     | 3 天     | 数据库          |
| 订单处理   | P0     | 高     | 5 天     | 账户余额 + 行情 |
| 撮合引擎   | P0     | 高     | 5 天     | 订单处理        |
| CCXT API   | P1     | 中     | 3 天     | 所有模块        |
| 管理界面   | P2     | 低     | 3 天     | CCXT API        |

---

## 2. 数据模型（最简设计）

### 2.1 核心表结构

```sql
-- 用户表
CREATE TABLE users (
  id         SERIAL PRIMARY KEY,
  email      VARCHAR(255) UNIQUE NOT NULL,
  api_key    VARCHAR(64) UNIQUE NOT NULL,
  api_secret VARCHAR(128) NOT NULL,
  created_at TIMESTAMP DEFAULT now()
);

-- 账户余额
CREATE TABLE balances (
  id        SERIAL PRIMARY KEY,
  user_id   INTEGER REFERENCES users(id),
  asset     VARCHAR(10) NOT NULL,
  available DECIMAL(20,8) DEFAULT 0,
  locked    DECIMAL(20,8) DEFAULT 0,
  UNIQUE(user_id, asset)
);

-- 订单表
CREATE TABLE orders (
  id          SERIAL PRIMARY KEY,
  user_id     INTEGER REFERENCES users(id),
  symbol      VARCHAR(20) NOT NULL,
  side        VARCHAR(4) NOT NULL,  -- buy/sell
  type        VARCHAR(10) NOT NULL, -- market/limit
  amount      DECIMAL(20,8) NOT NULL,
  price       DECIMAL(20,8),
  filled      DECIMAL(20,8) DEFAULT 0,
  status      VARCHAR(20) DEFAULT 'new', -- new/open/filled/canceled
  created_at  TIMESTAMP DEFAULT now(),
  updated_at  TIMESTAMP DEFAULT now()
);

-- 成交记录
CREATE TABLE trades (
  id        SERIAL PRIMARY KEY,
  order_id  INTEGER REFERENCES orders(id),
  user_id   INTEGER REFERENCES users(id),
  symbol    VARCHAR(20) NOT NULL,
  side      VARCHAR(4) NOT NULL,
  amount    DECIMAL(20,8) NOT NULL,
  price     DECIMAL(20,8) NOT NULL,
  fee       DECIMAL(20,8) DEFAULT 0,
  created_at TIMESTAMP DEFAULT now()
);

-- 行情数据（简化版）
CREATE TABLE tickers (
  symbol     VARCHAR(20) PRIMARY KEY,
  last_price DECIMAL(20,8) NOT NULL,
  bid_price  DECIMAL(20,8),
  ask_price  DECIMAL(20,8),
  volume_24h DECIMAL(20,8),
  updated_at TIMESTAMP DEFAULT now()
);
```

### 2.2 索引设计

```sql
-- 关键索引
CREATE INDEX idx_orders_user_status ON orders(user_id, status);
CREATE INDEX idx_orders_symbol_status ON orders(symbol, status);
CREATE INDEX idx_trades_user_time ON trades(user_id, created_at DESC);
CREATE INDEX idx_balances_user_asset ON balances(user_id, asset);
```

---

## 3. 核心业务流程

### 3.1 完整下单流程

```
┌─────────────┐
│ CCXT Client │
└──────┬──────┘
       │ 1. POST /v1/order
       │    {symbol, side, type, amount, price}
       ▼
┌──────────────────────────────────────┐
│      API Gateway (Echo)              │
│  • 参数解析                          │
│  • API Key 验证                      │
│  • 请求签名校验                      │
└──────┬───────────────────────────────┘
       │ 2. 验证通过
       ▼
┌──────────────────────────────────────┐
│      交易模块 (Trading Service)      │
│  • 订单参数验证                      │
│  • 检查交易对是否支持                │
│  • 价格/数量合法性检查               │
└──────┬───────────────────────────────┘
       │ 3. 参数有效
       ▼
┌──────────────────────────────────────┐
│      账户模块 (Account Service)      │
│  • 查询用户余额                      │
│  • 计算所需资金                      │
│    - Buy:  需要 amount * price USDT  │
│    - Sell: 需要 amount BTC           │
│  • 冻结相应资金                      │
└──────┬───────────────────────────────┘
       │ 4. 余额充足，资金已冻结
       ▼
┌──────────────────────────────────────┐
│      订单创建                        │
│  INSERT INTO orders                  │
│  • status = 'new'                    │
│  • filled = 0                        │
└──────┬───────────────────────────────┘
       │ 5. 订单入库
       ▼
┌──────────────────────────────────────┐
│      撮合引擎 (Matching Engine)      │
│                                      │
│  IF type == 'market':                │
│    • 获取当前市场价格                │
│    • 立即执行成交                    │
│    • 更新订单状态为 'filled'         │
│    • 生成成交记录                    │
│                                      │
│  IF type == 'limit':                 │
│    • 检查价格是否可成交              │
│    • 可成交: 执行成交逻辑            │
│    • 不可成交: 订单状态改为 'open'   │
│             等待后续撮合             │
└──────┬───────────────────────────────┘
       │ 6. 撮合完成
       ▼
┌──────────────────────────────────────┐
│      成交处理                        │
│  • 创建 trades 记录                  │
│  • 更新用户余额                      │
│    - 解冻冻结资金                    │
│    - 增加对应资产                    │
│  • 计算并扣除手续费                  │
└──────┬───────────────────────────────┘
       │ 7. 返回结果
       ▼
┌──────────────────────────────────────┐
│      响应客户端                      │
│  {                                   │
│    "id": "12345",                    │
│    "status": "filled",               │
│    "filled": "0.01",                 │
│    "average": "50000.00"             │
│  }                                   │
└──────────────────────────────────────┘
```

### 3.2 订单撮合逻辑

#### 3.2.1 市价单撮合

```
市价单处理流程:
  ┌───────────────┐
  │ 市价买单      │
  └───────┬───────┘
          │
          ▼
    ┌─────────────────┐
    │ 获取卖一价格    │  从 tickers 表或缓存获取 ask_price
    └────────┬────────┘
             │
             ▼
    ┌─────────────────┐
    │ 计算成交金额    │  amount * ask_price
    └────────┬────────┘
             │
             ▼
    ┌─────────────────┐
    │ 检查余额        │  available >= 成交金额?
    └────────┬────────┘
             │ 是
             ▼
    ┌─────────────────┐
    │ 执行成交        │
    │ • 扣除 USDT     │
    │ • 增加 BTC      │
    │ • 记录 trade    │
    └─────────────────┘

市价卖单处理流程:
  ┌───────────────┐
  │ 市价卖单      │
  └───────┬───────┘
          │
          ▼
    ┌─────────────────┐
    │ 获取买一价格    │  bid_price
    └────────┬────────┘
             │
             ▼
    ┌─────────────────┐
    │ 检查BTC余额     │  available >= amount?
    └────────┬────────┘
             │ 是
             ▼
    ┌─────────────────┐
    │ 执行成交        │
    │ • 扣除 BTC      │
    │ • 增加 USDT     │
    │ • 记录 trade    │
    └─────────────────┘
```

#### 3.2.2 限价单撮合

```
限价买单撮合:
  价格判断: order.price >= ask_price  →  可成交
           order.price < ask_price   →  挂单等待

限价卖单撮合:
  价格判断: order.price <= bid_price  →  可成交
           order.price > bid_price   →  挂单等待

撮合流程图:
  ┌───────────────┐
  │ 限价单        │
  └───────┬───────┘
          │
          ▼
    ┌─────────────────┐
    │ 获取市场价格    │
    └────────┬────────┘
             │
             ▼
    ┌─────────────────┐
    │ 价格匹配检查    │
    └────────┬────────┘
             │
        ┌────┴────┐
        │         │
     可成交    不可成交
        │         │
        ▼         ▼
   ┌────────┐  ┌──────────┐
   │立即成交│  │status =  │
   │        │  │'open'    │
   └────────┘  │进入订单薄│
               └──────────┘
```

---

## 4. API 设计 (CCXT 兼容)

### 4.1 API 架构

```
                    ┌─────────────────────────────────┐
                    │      CCXT Client SDK            │
                    │   (Python/JavaScript/...)       │
                    └────────────┬────────────────────┘
                                 │
                    ┌────────────▼────────────────────┐
                    │     HTTP REST API               │
                    │     (JSON Response)             │
                    └────────────┬────────────────────┘
                                 │
                ┌────────────────┴────────────────┐
                │                                 │
        ┌───────▼──────┐                 ┌───────▼──────┐
        │  公开接口    │                 │  私有接口    │
        │ (无需认证)   │                 │ (需要认证)   │
        └──────────────┘                 └──────────────┘
```

### 4.2 公开接口 (Public API)

| 端点                  | 方法 | 说明                | CCXT 对应        |
| --------------------- | ---- | ------------------- | ---------------- |
| `/v1/markets`         | GET  | 获取所有交易对信息  | `fetchMarkets()` |
| `/v1/ticker/{symbol}` | GET  | 获取指定交易对行情  | `fetchTicker()`  |
| `/v1/tickers`         | GET  | 获取所有行情 (可选) | `fetchTickers()` |
| `/v1/trades/{symbol}` | GET  | 获取最近成交记录    | `fetchTrades()`  |
| `/v1/time`            | GET  | 获取服务器时间      | -                |
| `/v1/ping`            | GET  | 健康检查            | -                |

#### 示例请求/响应

```http
GET /v1/ticker/BTC/USDT HTTP/1.1
Host: api.hypersim.local

HTTP/1.1 200 OK
Content-Type: application/json

{
  "symbol": "BTC/USDT",
  "timestamp": 1730419200000,
  "datetime": "2024-11-01T00:00:00.000Z",
  "high": 51000.00,
  "low": 49000.00,
  "bid": 49800.00,
  "ask": 49850.00,
  "last": 49820.00,
  "close": 49820.00,
  "baseVolume": 1234.56,
  "quoteVolume": 61234567.89,
  "info": {}
}
```

### 4.3 私有接口 (Private API)

| 端点                | 方法   | 说明           | CCXT 对应             |
| ------------------- | ------ | -------------- | --------------------- |
| `/v1/balance`       | GET    | 查询账户余额   | `fetchBalance()`      |
| `/v1/order`         | POST   | 创建订单       | `createOrder()`       |
| `/v1/order/{id}`    | GET    | 查询订单详情   | `fetchOrder()`        |
| `/v1/order/{id}`    | DELETE | 撤销订单       | `cancelOrder()`       |
| `/v1/orders`        | GET    | 查询订单列表   | `fetchOrders()`       |
| `/v1/orders/open`   | GET    | 查询未完成订单 | `fetchOpenOrders()`   |
| `/v1/orders/closed` | GET    | 查询已完成订单 | `fetchClosedOrders()` |
| `/v1/myTrades`      | GET    | 查询成交历史   | `fetchMyTrades()`     |

#### 示例：创建订单

```http
POST /v1/order HTTP/1.1
Host: api.hypersim.local
X-API-KEY: test_key_123
X-API-SIGNATURE: 3a5f8c9e...
Content-Type: application/json

{
  "symbol": "BTC/USDT",
  "side": "buy",
  "type": "limit",
  "amount": "0.01",
  "price": "50000.00"
}

---

HTTP/1.1 201 Created
Content-Type: application/json

{
  "id": "12345",
  "clientOrderId": null,
  "timestamp": 1730419200000,
  "datetime": "2024-11-01T00:00:00.000Z",
  "lastTradeTimestamp": null,
  "symbol": "BTC/USDT",
  "type": "limit",
  "side": "buy",
  "price": 50000.00,
  "amount": 0.01,
  "cost": 500.00,
  "filled": 0,
  "remaining": 0.01,
  "status": "open",
  "fee": null,
  "trades": [],
  "info": {}
}
```

### 4.4 认证机制

#### 4.4.1 API Key 生成

```text
生成流程:
1. 用户注册/登录
2. 系统生成唯一的 API Key 和 Secret
   - API Key:    32字符随机字符串 (公开)
   - API Secret: 64字符随机字符串 (私密,仅显示一次)
3. 存储到数据库 (Secret 加密存储)
```

#### 4.4.2 请求签名

```text
签名算法: HMAC-SHA256

步骤:
1. 构造待签名字符串
   payload = timestamp + method + path + body

2. 使用 API Secret 计算 HMAC
   signature = HMAC_SHA256(api_secret, payload)

3. 添加请求头
   X-API-KEY: {api_key}
   X-API-SIGNATURE: {signature}
   X-API-TIMESTAMP: {timestamp}
```

#### 4.4.3 签名示例 (Python)

```python
import hmac
import hashlib
import time
import json

def sign_request(api_secret, method, path, body=None):
    timestamp = str(int(time.time() * 1000))
    body_str = json.dumps(body) if body else ''

    payload = f"{timestamp}{method}{path}{body_str}"
    signature = hmac.new(
        api_secret.encode(),
        payload.encode(),
        hashlib.sha256
    ).hexdigest()

    return {
        'X-API-TIMESTAMP': timestamp,
        'X-API-SIGNATURE': signature
    }

# 使用示例
headers = sign_request(
    api_secret='your_secret',
    method='POST',
    path='/v1/order',
    body={'symbol': 'BTC/USDT', 'side': 'buy', 'amount': 0.01}
)
```

### 4.5 错误响应格式

```json
{
  "error": {
    "code": "INSUFFICIENT_BALANCE",
    "message": "Insufficient USDT balance",
    "details": {
      "required": "500.00",
      "available": "100.00"
    }
  }
}
```

#### 错误代码表

| 错误码                   | HTTP 状态 | 说明           |
| ------------------------ | --------- | -------------- |
| `INVALID_API_KEY`        | 401       | API Key 无效   |
| `INVALID_SIGNATURE`      | 401       | 签名验证失败   |
| `INVALID_SYMBOL`         | 400       | 交易对不存在   |
| `INVALID_AMOUNT`         | 400       | 数量参数非法   |
| `INVALID_PRICE`          | 400       | 价格参数非法   |
| `INSUFFICIENT_BALANCE`   | 400       | 余额不足       |
| `ORDER_NOT_FOUND`        | 404       | 订单不存在     |
| `ORDER_ALREADY_FILLED`   | 400       | 订单已成交     |
| `ORDER_ALREADY_CANCELED` | 400       | 订单已撤销     |
| `RATE_LIMIT_EXCEEDED`    | 429       | 请求频率超限   |
| `INTERNAL_ERROR`         | 500       | 服务器内部错误 |

---

## 5. 行情数据获取

### 5.1 数据源

- 主要：Binance REST API
- 频率：每秒更新一次（MVP 够用）
- 缓存：内存缓存 + 数据库持久化

### 5.2 更新机制

```go
// 简单定时任务
func (m *MarketData) updateTickers() {
    ticker, err := binanceAPI.GetTicker("BTCUSDT")
    if err != nil {
        log.Error("获取行情失败", err)
        return
    }

    // 更新内存缓存
    m.cache["BTC/USDT"] = ticker

    // 持久化到数据库
    db.Save(&Ticker{
        Symbol: "BTC/USDT",
        LastPrice: ticker.Last,
        BidPrice: ticker.Bid,
        AskPrice: ticker.Ask,
        UpdatedAt: time.Now(),
    })
}
```

---

## 6. 部署配置（单机版）

### 6.1 Docker Compose

```yaml
version: "3.8"
services:
  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      - DB_HOST=db
      - DB_NAME=hypersim
      - DB_USER=postgres
      - DB_PASS=password
      - BINANCE_API_URL=https://api.binance.com
    depends_on:
      - db

  db:
    image: postgres:16
    environment:
      POSTGRES_DB: hypersim
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    volumes:
      - db_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

volumes:
  db_data:
```

### 6.2 环境变量

```bash
# 数据库配置
DB_HOST=localhost
DB_PORT=5432
DB_NAME=hypersim
DB_USER=postgres
DB_PASS=password

# 外部 API
BINANCE_API_URL=https://api.binance.com
MARKET_UPDATE_INTERVAL=1s

# 服务配置
PORT=8080
LOG_LEVEL=info
DEBUG=true
```

---

## 7. 开发计划

### 7.1 第一阶段（1-2 周）

- [ ] 项目脚手架搭建
- [ ] 数据库表结构创建
- [ ] 基础 API 框架（Echo）
- [ ] 用户认证机制

### 7.2 第二阶段（1-2 周）

- [ ] 行情数据获取和存储
- [ ] 账户余额管理
- [ ] 基础下单功能
- [ ] 简单撮合引擎

### 7.3 第三阶段（1-2 周）

- [ ] CCXT 兼容性测试
- [ ] 订单查询和撤销
- [ ] 成交记录查询
- [ ] 基础错误处理

### 7.4 第四阶段（1 周）

- [ ] 集成测试
- [ ] 部署文档
- [ ] 简单前端界面（可选）

---

## 8. 测试策略

### 8.1 单元测试重点

- 余额计算逻辑
- 订单状态流转
- 价格匹配算法
- API 参数验证

### 8.2 集成测试

- 完整下单流程
- CCXT 客户端兼容性
- 数据库事务一致性

### 8.3 测试数据

```sql
-- 初始化测试用户
INSERT INTO users (email, api_key, api_secret) VALUES
('test@example.com', 'test_key_123', 'test_secret_456');

-- 初始化余额
INSERT INTO balances (user_id, asset, available) VALUES
(1, 'USDT', 10000),
(1, 'BTC', 0);
```

---

## 9. 技术决策与权衡

### 9.1 核心技术选型

#### 选择 PostgreSQL 而非 MySQL

```
优势:
  ✓ 更好的 JSON/JSONB 支持
  ✓ 更强的事务隔离级别 (MVCC)
  ✓ TimescaleDB 扩展 (时序数据)
  ✓ 更完善的约束和索引

权衡:
  ✗ 初始配置略复杂
  ✗ 内存占用相对较高
```

#### 选择单体应用而非微服务

```
优势:
  ✓ 开发速度快
  ✓ 调试简单直观
  ✓ 部署运维成本低
  ✓ 事务一致性容易保证
  ✓ 满足 MVP 性能需求

权衡:
  ✗ 后期扩展需重构
  ✗ 单点故障风险

扩展计划:
  v2.0 可按模块拆分为微服务
```

#### 选择内存缓存而非 Redis

```
优势:
  ✓ 零延迟访问
  ✓ 减少外部依赖
  ✓ 降低运维复杂度
  ✓ MVP 阶段足够用

权衡:
  ✗ 重启数据丢失
  ✗ 无法跨实例共享

迁移方案:
  v2.0 可平滑迁移到 Redis
```

### 9.2 业务简化决策

#### 只支持一个交易对 (BTC/USDT)

```
理由:
  1. 降低复杂度，快速验证核心逻辑
  2. 减少测试工作量
  3. 简化行情同步逻辑
  4. 专注撮合引擎优化

扩展路径:
  v1.1: 增加 ETH/USDT
  v1.2: 支持多交易对配置化
  v2.0: 支持任意交易对
```

#### 简化撮合算法

```
MVP 方案:
  • 市价单: 直接使用外部交易所价格成交
  • 限价单: 简单价格匹配，不维护完整订单薄

简化内容:
  ✗ 不实现订单薄深度
  ✗ 不做价格优先时间优先排序
  ✗ 不支持部分成交 (MVP仅全量)

后续优化:
  v1.5: 实现内存订单薄
  v2.0: 完整撮合引擎 (价格时间优先)
```

### 9.3 技术栈对比

| 技术         | 选型       | 备选方案       | 选择理由               |
| ------------ | ---------- | -------------- | ---------------------- |
| **语言**     | Go         | Rust, Java     | 并发性能好、开发效率高 |
| **Web 框架** | Echo       | Gin, Fiber     | 文档完善、中间件丰富   |
| **ORM**      | GORM       | sqlx, ent      | 开发便捷、社区活跃     |
| **数据库**   | PostgreSQL | MySQL, MongoDB | 事务支持强、扩展性好   |
| **缓存**     | In-Memory  | Redis          | MVP 阶段无需外部依赖   |
| **日志**     | Zap        | Logrus         | 性能最优               |
| **配置**     | Viper      | 自定义         | 标准化配置管理         |

### 9.4 性能目标 (MVP)

```
┌─────────────────────────────────────────────────────┐
│              性能指标 (单机环境)                    │
├─────────────────────┬───────────────────────────────┤
│ API 响应时间        │ P99 < 100ms                   │
│ 下单处理            │ > 100 TPS                     │
│ 订单查询            │ > 500 QPS                     │
│ 行情更新延迟        │ < 2s                          │
│ 数据库连接池        │ 20-50 连接                    │
│ 内存占用            │ < 500MB                       │
│ CPU 使用率          │ < 30% (空闲时)                │
└─────────────────────┴───────────────────────────────┘

注: 以上指标基于 2核4G 服务器
```

---

## 10. 开发路线图与后续计划

### 10.1 里程碑规划

```
┌──────────────────────────────────────────────────────────────────┐
│                        开发时间线                                │
├────────────┬──────────────────────────────────────────────────────┤
│            │                                                      │
│  Week 1-2  │  ▓▓▓▓▓▓▓▓▓▓  基础设施                               │
│            │  • 项目初始化、数据库设计、API框架                  │
│            │                                                      │
│  Week 3-4  │  ▓▓▓▓▓▓▓▓▓▓  核心功能                               │
│            │  • 行情同步、账户管理、订单系统                      │
│            │                                                      │
│  Week 5-6  │  ▓▓▓▓▓▓▓▓▓▓  撮合引擎                               │
│            │  • 市价/限价单撮合、订单状态管理                     │
│            │                                                      │
│  Week 7    │  ▓▓▓▓▓      测试优化                                │
│            │  • 集成测试、CCXT兼容性、性能测试                    │
│            │                                                      │
│  Week 8    │  ▓▓▓        部署上线                                │
│            │  • 文档完善、部署脚本、监控配置                      │
└────────────┴──────────────────────────────────────────────────────┘
```

### 10.2 详细任务分解

#### 阶段 1: 基础设施 (Week 1-2)

| 任务              | 负责人 | 工时 | 依赖    | 验收标准          |
| ----------------- | ------ | ---- | ------- | ----------------- |
| 项目脚手架搭建    | 后端   | 0.5d | -       | Go 项目可运行     |
| Echo 框架集成     | 后端   | 0.5d | 脚手架  | HTTP 服务启动     |
| PostgreSQL 配置   | 后端   | 1d   | -       | 数据库连接成功    |
| GORM 集成与表设计 | 后端   | 2d   | PG 配置 | 表结构自动迁移    |
| 基础中间件        | 后端   | 1d   | Echo    | 日志/错误处理完成 |
| API Key 认证      | 后端   | 2d   | 中间件  | 签名验证通过      |
| 单元测试框架      | 后端   | 1d   | -       | 测试可运行        |
| Docker 配置       | DevOps | 1d   | -       | 容器化部署        |

#### 阶段 2: 核心功能 (Week 3-4)

| 任务          | 负责人 | 工时 | 依赖     | 验收标准         |
| ------------- | ------ | ---- | -------- | ---------------- |
| 行情数据获取  | 后端   | 2d   | DB       | Binance 数据入库 |
| 行情缓存机制  | 后端   | 1d   | 行情获取 | 内存缓存生效     |
| 定时任务框架  | 后端   | 1d   | -        | 定时更新运行     |
| 用户管理 API  | 后端   | 1d   | 认证     | 注册/登录成功    |
| 余额查询/更新 | 后端   | 2d   | 用户     | 余额 CRUD 完成   |
| 资金冻结/解冻 | 后端   | 2d   | 余额     | 事务一致性       |
| 公开 API 实现 | 后端   | 1d   | 行情     | CCXT 可调用      |
| 私有 API 框架 | 后端   | 1d   | 认证     | 鉴权通过         |

#### 阶段 3: 撮合引擎 (Week 5-6)

| 任务         | 负责人 | 工时 | 依赖      | 验收标准      |
| ------------ | ------ | ---- | --------- | ------------- |
| 订单创建流程 | 后端   | 2d   | 余额      | 订单入库成功  |
| 参数验证逻辑 | 后端   | 1d   | 订单      | 非法参数拦截  |
| 市价单撮合   | 后端   | 3d   | 订单+行情 | 市价单成交    |
| 限价单撮合   | 后端   | 3d   | 市价单    | 限价单成交    |
| 订单状态管理 | 后端   | 2d   | 撮合      | 状态流转正确  |
| 成交记录生成 | 后端   | 2d   | 撮合      | trades 表完整 |
| 订单查询 API | 后端   | 1d   | 订单      | 多条件查询    |
| 订单撤销逻辑 | 后端   | 2d   | 订单      | 资金正确解冻  |

#### 阶段 4: 测试上线 (Week 7-8)

| 任务          | 负责人 | 工时 | 依赖     | 验收标准      |
| ------------- | ------ | ---- | -------- | ------------- |
| 单元测试补充  | 后端   | 3d   | 所有模块 | 覆盖率>70%    |
| 集成测试      | 测试   | 3d   | 所有模块 | 核心流程通过  |
| CCXT 兼容测试 | 测试   | 2d   | API      | CCXT 脚本运行 |
| 性能压测      | 测试   | 2d   | 所有模块 | 达到性能目标  |
| 部署文档      | DevOps | 1d   | Docker   | 可按文档部署  |
| 监控配置      | DevOps | 1d   | 部署     | 日志可查询    |
| 生产环境部署  | DevOps | 1d   | 文档     | 线上服务可用  |

### 10.3 版本演进计划

#### v1.0 (MVP) - 当前版本

```
核心功能:
  ✓ BTC/USDT 现货交易
  ✓ 市价单、限价单
  ✓ CCXT 基础兼容
  ✓ 简单撮合引擎
  ✓ 账户余额管理

目标用户:
  • 内部测试
  • 小规模验证
```

#### v1.5 (功能增强) - Q1 2025

```
新增功能:
  + 支持 2-3 个主流交易对
  + 订单部分成交
  + 订单薄可视化
  + WebSocket 行情推送
  + 基础风控 (频率限制)

性能提升:
  • 撮合引擎优化
  • 数据库索引优化
  • 缓存策略完善
```

#### v2.0 (架构升级) - Q2 2025

```
架构改进:
  + 微服务拆分 (可选)
  + Redis 集成
  + 消息队列 (RabbitMQ)
  + 高可用部署

业务扩展:
  + 合约交易基础
  + 止损止盈订单
  + 高级风控策略
  + 用户权限系统
  + 多语言支持
```

#### v3.0 (企业级) - Q3-Q4 2025

```
企业特性:
  + 完整订单薄深度
  + 多机房部署
  + 灾备方案
  + 完整监控告警
  + 审计日志
  + API 限流控制

性能目标:
  • > 10,000 TPS
  • P99 < 50ms
  • 99.9% 可用性
```

### 10.4 风险与应对

| 风险类型     | 风险描述                   | 影响 | 概率 | 应对措施               |
| ------------ | -------------------------- | ---- | ---- | ---------------------- |
| **技术风险** | Go 并发 bug 导致数据不一致 | 高   | 中   | 加强单元测试、代码审查 |
| **性能风险** | 单机性能无法满足需求       | 中   | 低   | 提前压测、优化索引     |
| **数据风险** | 数据库数据丢失             | 高   | 低   | 定期备份、主从同步     |
| **依赖风险** | Binance API 限流/下线      | 中   | 中   | 多数据源备份           |
| **安全风险** | API Key 泄露               | 高   | 中   | 加密存储、定期轮换     |
| **进度风险** | 开发延期影响上线           | 中   | 中   | 敏捷迭代、MVP 优先     |

### 10.5 成功指标

```
技术指标:
  □ API 响应 P99 < 100ms
  □ 系统可用性 > 99%
  □ 单元测试覆盖率 > 70%
  □ CCXT 兼容性测试通过率 100%

业务指标:
  □ 支持完整现货交易流程
  □ 订单成交准确率 100%
  □ 余额计算准确率 100%

用户指标:
  □ 内部测试用户 > 5 人
  □ 完成 > 1000 笔测试订单
  □ 无重大 bug
```

---

## 11. 总结

### 11.1 MVP 核心价值

本 MVP 设计遵循"**快速验证、持续迭代**"的原则，专注于实现模拟交易所的核心功能：

```
┌────────────────────────────────────────────────────────┐
│              MVP 价值主张                              │
├────────────────────────────────────────────────────────┤
│                                                        │
│  1. 快速验证   →  8周内完成核心功能开发               │
│                                                        │
│  2. 技术可行   →  验证 Go + PostgreSQL 技术栈         │
│                                                        │
│  3. CCXT兼容   →  可直接对接现有量化策略               │
│                                                        │
│  4. 低成本     →  单机部署，无复杂外部依赖             │
│                                                        │
│  5. 可扩展     →  为后续版本预留扩展接口               │
│                                                        │
└────────────────────────────────────────────────────────┘
```

### 11.2 关键设计决策

| 决策点     | 选择            | 理由                 |
| ---------- | --------------- | -------------------- |
| 架构模式   | 单体应用        | 快速开发、易于调试   |
| 交易对数量 | 单个 (BTC/USDT) | 降低复杂度、聚焦核心 |
| 撮合方式   | 简化撮合        | MVP 够用、后续可升级 |
| 缓存方案   | 内存缓存        | 减少依赖、性能足够   |
| 部署方式   | Docker 单机     | 运维简单、成本低     |

### 11.3 后续演进路径

```
MVP (v1.0)  →  功能增强 (v1.5)  →  架构升级 (v2.0)  →  企业级 (v3.0)
    │               │                   │                    │
    │               │                   │                    │
单交易对         多交易对            微服务拆分         完整交易所
基础撮合         订单薄              消息队列           高可用集群
内存缓存         Redis缓存           监控告警           完整风控
REST API        WebSocket           合约交易           多机房部署
```

### 11.4 开发建议

```text
1. 遵循敏捷开发
   - 2周一个迭代
   - 持续集成/部署
   - 快速反馈调整

2. 代码质量优先
   - 单元测试先行
   - 代码审查必须
   - 文档同步更新

3. 性能监控常态化
   - 关键接口埋点
   - 定期压测验证
   - 及时优化瓶颈

4. 预留扩展接口
   - 接口设计考虑未来
   - 模块解耦易于拆分
   - 配置化优于硬编码
```

---

**文档版本**: MVP v1.0  
**最后更新**: 2024-11-01  
**维护者**: Quicksilver Team  
**下一步**: 开始 Phase 1 开发 🚀
