---
description: "代码质量体检（静态分析 + 风格一致性 + 复杂度热点 + 测试健康 + 改进建议）"
argument-hint: "可选参数：TARGET=./src STACK=auto FIX=off"
allowed-tools: ["Read", "Edit"]
model: claude-4-5-sonnet
---

## 任务

对项目进行**全面代码质量检查**，不执行外部命令，仅通过静态分析与代码语义推理完成。

## 参数

- `TARGET=${TARGET:=./}`
- `STACK=${STACK:=auto}` # 语言自动检测，可指定 go、node、python
- `FIX=${FIX:=off}` # off：仅报告；on：允许自动小修复

## 检查重点

1. **风格与结构**

   - 命名一致性、模块组织、函数职责是否单一。
   - 是否存在重复逻辑、过长函数、嵌套层级过深。

2. **复杂度与风险**

   - 计算函数圈复杂度、长参数列表、分支爆炸点。
   - 标记“潜在崩溃点”与“高维护成本函数”。

3. **健壮性**

   - 错误处理完整性（是否忽略返回值、error）。
   - 并发访问安全性（锁粒度、defer、goroutine 泄漏风险）。
   - 资源释放与异常恢复（defer、try/catch/finally、context cancel）。

4. **测试健康**

   - 核心功能是否有 `_test` 文件。
   - 是否存在表格驱动测试、边界/错误用例。
   - 测试命名清晰、断言合理、无过度依赖实现细节。

5. **改进建议**

   - 对每类问题给出 2~3 条优化建议（重构思路、封装方式、抽象层改进）。

6. **苏格拉底式提问**
   - “这个模块是否承担了超出它定义的职责？”
   - “哪些复杂度是源于需求，哪些是自找的？”
   - “哪些错误处理只是形式，而非实质？”
   - “如果删掉一半的日志，我们还能定位问题吗？”
   - “团队中其他人读这段代码，会需要多长时间理解？”

## 输出结构

请生成一份结构化报告：

- **总体评价**（一句话总结项目健康度）
- **主要发现（Top 5）**：含文件、函数名、问题类别与建议
- **复杂度分析表**（按函数或模块列出）
- **测试健康摘要**（哪些模块缺失、哪些可改进）
- **改进建议清单**
- **反思提问清单**

> 若 FIX=on，可在不破坏逻辑的前提下，对明显问题（命名、重复、格式）自动修复并说明理由。
